<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Profile page head -->
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2>Edit Profile</h2>

        <!-- Current username and change username button -->
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:6px; color:#2d3436; font-weight:500;">Current username</label>
            <div style="display:flex; align-items:center; gap:12px;">
                <strong id="currentUsername" style="font-size:16px; color:#2d3436;"></strong>
            </div>
        </div>

        <!-- Profile edit form -->
        <form id="profileForm">
            <label for="first_name">First name</label>
            <input type="text" name="first_name" id="first_name" placeholder="First name" required>
            <label for="last_name">Last name</label>
            <input type="text" name="last_name" id="last_name" placeholder="Last name" required>
            <label for="gender">Gender</label>
            <select name="gender" id="gender" required>
                <option value="" disabled>Gender</option>
                <option value="male">&#9794; Male</option>
                <option value="female">&#9792; Female</option>
                <option value="other">&#9895; Other</option>
            </select>
            <label for="birthdate">Birthdate</label>
            <input type="date" name="birthdate" id="birthdate" placeholder="Birthdate" required>
            <button type="submit">Save changes</button>
            <button type="button" id="logoutBtn" style="background:#d63031;margin-top:8px;">Logout</button>
            <button type="button" id="changePasswordBtn" style="background:#636e72;margin-top:8px;">Change password</button>
            <!-- Change username button -->
            <button type="button" id="openChangeUsername" style="background:#6c5ce7;margin-top:8px;">Change username</button>
        </form>
        <div id="profileMsg" class="msg"></div>

        <!-- Change password modal -->
        <div id="modal">
            <div>
                <h3 style="margin-top:0;">Change password</h3>
                <form id="passwordForm">
                    <label for="old_password">Old password</label>
                    <input type="password" name="old_password" id="old_password" required>
                    <label for="new_password">New password</label>
                    <input type="password" name="new_password" id="new_password" required>
                    <button type="submit" style="background:#00b894;">Change</button>
                    <button type="button" id="closeModalBtn" style="background:#d63031; margin-left:8px;">Cancel</button>
                </form>
                <div id="passwordMsg" class="msg"></div>
            </div>
        </div>

        <!-- Change username modal (with password confirmation) -->
        <div id="usernameModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); justify-content:center; align-items:center;">
            <div style="background:#fff; padding:24px 32px; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.15); min-width:300px; position:relative;">
                <h3 style="margin-top:0;">Change username</h3>
                <form id="usernameForm">
                    <label for="new_username">New username</label>
                    <input type="text" name="new_username" id="new_username" required>
                    <label for="username_password">Confirm current password</label>
                    <input type="password" name="username_password" id="username_password" required>
                    <button type="submit" style="background:#00b894;">Change</button>
                    <button type="button" id="closeUsernameModal" style="background:#d63031; margin-left:8px;">Cancel</button>
                </form>
                <div id="usernameMsg" class="msg"></div>
            </div>
        </div>

    </div>
    <script>
        // Get JWT token from localStorage
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'index.html';

        // Escape HTML to prevent XSS
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[<>&"'`]/g, function (c) {
                return ({
                    '<': '&lt;',
                    '>': '&gt;',
                    '&': '&amp;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '`': '&#96;'
                })[c];
            });
        }

        // Load user profile data
        async function loadProfile() {
            const res = await fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (data.error) {
                document.getElementById('profileMsg').textContent = escapeHTML(data.error);
                document.getElementById('profileMsg').className = 'msg error';
                return;
            }
            document.getElementById('currentUsername').textContent = escapeHTML(data.username);
            const form = document.getElementById('profileForm');
            form.first_name.value = escapeHTML(data.first_name);
            form.last_name.value = escapeHTML(data.last_name);
            form.gender.value = escapeHTML(data.gender);
            form.birthdate.value = data.birthdate ? escapeHTML(data.birthdate.slice(0,10)) : '';
        }
        loadProfile();

        // Save profile changes (without username)
        document.getElementById('profileForm').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const res = await fetch('/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    first_name: form.first_name.value,
                    last_name: form.last_name.value,
                    gender: form.gender.value,
                    birthdate: form.birthdate.value
                })
            });
            const data = await res.json();
            document.getElementById('profileMsg').textContent = data.error || 'Profile updated successfully!';
            document.getElementById('profileMsg').className = data.error ? 'msg error' : 'msg success';
        };

        // Open/close change username modal
        document.getElementById('openChangeUsername').onclick = () => {
            document.getElementById('usernameModal').style.display = 'flex';
            document.getElementById('usernameMsg').textContent = '';
            document.getElementById('new_username').value = '';
            document.getElementById('username_password').value = '';
        };
        document.getElementById('closeUsernameModal').onclick = () => {
            document.getElementById('usernameModal').style.display = 'none';
        };

        // Change username form submit handler (with password confirmation)
        document.getElementById('usernameForm').onsubmit = async (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('new_username').value.trim();
            const password = document.getElementById('username_password').value;
            if (!newUsername || !password) return;
            const res = await fetch('/api/change-username', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ new_username: newUsername, password })
            });
            const data = await res.json();
            document.getElementById('usernameMsg').textContent = data.error || 'Username changed successfully!';
            document.getElementById('usernameMsg').className = data.error ? 'msg error' : 'msg success';
            if (!data.error) {
                document.getElementById('currentUsername').textContent = data.username || newUsername;
                setTimeout(() => { document.getElementById('usernameModal').style.display = 'none'; }, 1000);
            }
        };

        // Open change password modal
        document.getElementById('changePasswordBtn').onclick = () => {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('passwordMsg').textContent = '';
        };

        // Close change password modal
        document.getElementById('closeModalBtn').onclick = () => {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('passwordForm').reset();
        };

        // Change password form submit handler
        document.getElementById('passwordForm').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const res = await fetch('/api/change-password', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    old_password: form.old_password.value,
                    new_password: form.new_password.value
                })
            });
            const data = await res.json();
            document.getElementById('passwordMsg').textContent = data.error || 'Password changed successfully!';
            document.getElementById('passwordMsg').className = data.error ? 'msg error' : 'msg success';
            if (!data.error) {
                setTimeout(() => {
                    document.getElementById('modal').style.display = 'none';
                    form.reset();
                }, 1500);
            }
        };

        // Logout button handler
        document.getElementById('logoutBtn').onclick = () => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>
